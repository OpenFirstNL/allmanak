# See https://nginx.org/en/docs/http/ngx_http_sub_module.html
# only explicitly work on the OpenAPI description endpoint (by mime-type and url)
sub_filter_types application/openapi+json;
# Fix the not yet online version 6.0 to rewrite it to 5.2 to prevent 404 links
# sub_filter '"url":"https://postgrest.org/en/v6.0/api.html","description":"PostgREST Documentation"' '"url":"https://postgrest.org/en/v5.2/api.html","description":"PostgREST Documentation (version 5.2, since 6.0 is not yet online)"';
# remove all non-get OpenAPI endpoints:
# since the max = 4096 for the nginx config line buffer (https://github.com/nginx/nginx/blob/master/src/core/ngx_conf_file.c#L11), we need to stay (way) below this, since we need to do the ${dollar} replacement at the end (otherwise we might cut the variable name)
# $ curl -sSf $(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' allmanak_api-rest-v1_1)':3000/' | jq '.paths[]|select(.post? != null)|to_entries[1:]|from_entries|","+tojson[1:-1]|. as $str|range(0; length/3000)|$str[.*3000:(.+1)*3000]|sub("\\$";"${dollar}";"g")|sub("\\\\";"\\\\";"g")|'"\"sub_filter '\"+.+\"' '';\"" -r > nginx/shared/v1-generated-strip-openapi-edits.conf
include shared/v1-generated-strip-openapi-edits.conf;
# the default given tags (=Swagger UI header + grouping) which is the view name by PostgREST is useless after removing all non-get endpoints
# for the resulting OpenAPI response it makes more sense to group on the schema of the table of the view:
# $ docker-compose exec -T db psql -U postgres allmanak -t -c "SELECT JSONB_OBJECT_AGG(schema, list_of_views) FROM (SELECT sch.nspname AS schema, JSONB_AGG(c.relname) AS list_of_views FROM pg_class c JOIN pg_namespace n ON n.oid = c.relnamespace JOIN pg_rewrite r ON r.ev_class = c.oid JOIN pg_class tbl ON tbl.oid::text=SUBSTRING(r.ev_action FROM ':resorigtbl (.*?) :') JOIN pg_namespace sch ON sch.oid = tbl.relnamespace WHERE c.relkind = 'v' AND n.nspname = 'api_v1' GROUP BY sch.nspname) a;" | jq "to_entries[]|((.key[0:1]|ascii_upcase)+.key[1:]) as \$SCHEMA|.value[]|[{tags:[.]},{tags:[\$SCHEMA]}]|\"sub_filter '\\(.[0]|@json|.[1:-1]),' '\\(.[1]|@json|.[1:-1]),';\"" -r > nginx/shared/v1-generated-replace-grouping-tags.conf
include shared/v1-generated-replace-grouping-tags.conf;
sub_filter '"info":{"version":"6.0.0 (4175e5b)","title":"PostgREST API",' '"tags":[{"name":"Almanak","description":"Data uit de overheidsalmanak","externalDocs":{"description":"source data (XML)","url":"https://almanak.overheid.nl/archive/"}},{"name":"Kiesraad","description":"geconverteerde EML data van de kiesraad","externalDocs":{"description":"source data (EML)","url":"https://data.overheid.nl/dataset/1/25?search=EML"}},{"name":"Enrich","description":"enrichment d.m.v scraping en linking"}],"info":{"version":"v1.1.0","title":"Allmanak REST API",';

#sub_filter '"P":"https://postgrest.org/en/v6.0/api.html","description":"PostgREST Documentation"' '"url":"https://postgrest.org/en/v5.2/api.html","description":"PostgREST Documentation (version 5.2, since 6.0 is not yet online)"';